---
layout: post
title: Box2D创建简单的几何形状
category: Box2D
---
#{{page.title}}
Box2D中形状(shape)和设备(fixture)属于一对一关系, fixture中的shape属性指向了一个Shape实例,
而fixture的其他参数则定义了Shape的一些物理特性,如摩擦系数, 弹性系数等。
##Box2D中的形状
在Box2D中主要包括了圆形(b2CircleShape)和多边形(b2PolygonShape), 两者的定义在Box2D.Collision.Shapes包中。
继承于b2Shape。
##创建形状的步骤
Box2D创建形状的步骤极其简单, 只需实例化一个Shape。然而要使Shape在世界(World)中绘制出来,
还需要通过设备(Fixture)的shape属性与之关联，接着设备(Fixture)通过刚体(Body)的createFixture()方法添加至刚体中,
最后, 刚体(Body)则使用世界(World)的createBody()方法加入世界中, 至此形状才被添加到世界中。
##创建简单的矩形
简单矩形只需要通过调用b2PolygonShape实例的setAsBox()方法即可, 改方法接收2个参数: 矩形的中心点坐标x, 矩形的中心点坐标y。
这与HTML5中的Canvas的创建矩形方式有些不同，Canvas是接收起点坐标和终点坐标为参数创建矩形。
Box2D会根据Shape所依附的刚体的原点坐标计算矩形的尺寸。 以下代码展示了一个创建“地板”的方法：

```javascript
//short cut
var b2Vec2 = Box2D.Common.Math.b2Vec2,
    b2BodyDef = Box2D.Dynamics.b2BodyDef,
    b2Body = Box2D.Dynamics.b2Body,
    b2FixtureDef = Box2D.Dynamics.b2FixtureDef,
    b2Fixture = Box2D.Dynamics.b2Fixture,
    b2World = Box2D.Dynamics.b2World,
    b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape,
    b2CircleShape = Box2D.Collision.Shapes.b2CircleShape,
    b2DebugDraw = Box2D.Dynamics.b2DebugDraw,
    b2RevoluteJointDef = Box2D.Dynamics.Joints.b2RevoluteJointDef;

//30pixel 为现实的1米
var scale = 30;

//重力系数
var gravity = new b2Vec2(0, 9.8);

//允许睡眠
var allowSleep = true;
var world = new b2World(gravity, allowSleep);

function createFloor() {
    //创建刚体定义数据对象
    var bodyDef = new b2BodyDef;
    //为静态刚体, 即不受碰撞影响
    bodyDef.type = b2Body.b2_staticBody;
    //刚体原点位置
    bodyDef.position.x = 640 / 2 / scale;
    bodyDef.position.y = 470 / scale;

    //创建设备定义数据对象
    var fixtureDef = new b2FixtureDef;
    //密度
    fixtureDef.density = 1.0;
    //摩擦
    fixtureDef.friction = 0.5;
    //恢复系数
    fixtureDef.restitution = 0.2;
    //设备形状为多边形
    fixtureDef.shape = new b2PolygonShape;
    //设置为矩形
    fixtureDef.shape.SetAsBox(320 / scale, 10 / scale); //640 pixels wide and 20 pixels tall

    //世界创建刚体, 刚体创建设备, 设备拥有形状
    var body = world.CreateBody(bodyDef);
    var fixture = body.CreateFixture(fixtureDef);
}
```
上述代码的流程如下:
1. 创建了Box2D一些常用对象的短引用;
2. 创建放大比例和重力系数, 设置是否允许睡眠, 创建世界;
3. 定义createFloor函数, 在函数中创建刚体, 创建设备, 创建形状, 设置形状的中心点;
4. 将刚体添加到世界, 将设备添加到刚体。
注意代码中， bodyDef.type = b2Body.b2_staticBody; 这行代码设置了该刚体为静态刚体,即不受碰撞影响。
下面创建一个受到重力和弹性系数影响的矩形:
```javascript
function createRectangularBody() {
    var bodyDef = new b2BodyDef;
    bodyDef.type = b2Body.b2_dynamicBody;
    bodyDef.position.x = 40 / scale;
    bodyDef.position.y = 100 / scale;
    var fixtureDef = new b2FixtureDef;
    fixtureDef.density = 1.0;
    fixtureDef.friction = 0.5;
    fixtureDef.restitution = 0.3;
    fixtureDef.shape = new b2PolygonShape;
    fixtureDef.shape.SetAsBox(30 / scale, 50 / scale);
    var body = world.CreateBody(bodyDef);
    var fixture = body.CreateFixture(fixtureDef);
}
```
##创建圆形
创建圆形通过实例化b2CircleShape, 传入圆形半径即可, 创建圆的代码与创建矩形的代码基本相同:

```javascript
function createCircularBody() {
    var bodyDef = new b2BodyDef;
    bodyDef.type = b2Body.b2_dynamicBody;
    bodyDef.position.x = 130 / scale;
    bodyDef.position.y = 100 / scale;
    var fixtureDef = new b2FixtureDef;
    fixtureDef.density = 1.0;
    fixtureDef.friction = 0.5;
    fixtureDef.restitution = 0.7;
    fixtureDef.shape = new b2CircleShape(30 / scale);
    var body = world.CreateBody(bodyDef);
    var fixture = body.CreateFixture(fixtureDef);
}
```
##创建简单的多边形
矩形是特殊多边形的一种, 现在要创建是比矩形稍微复杂一些的多边形。这是通过调用b2PolygonShape的setAsArray()方法来完成的。
该方法接收2个参数：多边形各个点的坐标向量，点的个数。 坐标向量通过b2Vec创建。Box2D按照顺时针方向将点连接起来，点的方向不要弄错。
以下代码创建了一个五边形:

```javascript
function createSimplePolygonBody() {
    var bodyDef = new b2BodyDef;
    bodyDef.type = b2Body.b2_dynamicBody;
    bodyDef.position.x = 230 / scale;
    bodyDef.position.y = 50 / scale;
    var fixtureDef = new b2FixtureDef;
    fixtureDef.density = 1.0;
    fixtureDef.friction = 0.5;
    fixtureDef.restitution = 0.2;
    fixtureDef.shape = new b2PolygonShape;
    // Create an array of b2Vec2 points in clockwise direction
    var points = [
        new b2Vec2(0, 0),
        new b2Vec2(40 / scale, 50 / scale),
        new b2Vec2(50 / scale, 100 / scale),
        new b2Vec2(-50 / scale, 100 / scale),
        new b2Vec2(-40 / scale, 50 / scale),
    ];
    // Use SetAsArray to define the shape using the points array
    fixtureDef.shape.SetAsArray(points, points.length);
    var body = world.CreateBody(bodyDef);
    var fixture = body.CreateFixture(fixtureDef);
}
```

##总结
Box2D提供了两个Shape类, b2CirleShape与b2PolygonShape, 通过b2PolygonShape,可以创造出任意多边形物体。
世界中的物体总是带有许多物理参数，而这些参数在Box2D中则由设备来持有维护。
代码的聚合DEMO可以见此: [Box2D-DEMO](/demo/box2d-demo)。 DEMO中包括了后面要介绍的复杂几何形状的暂时。
